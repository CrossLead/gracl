<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>gracl</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
	<script src="assets/js/modernizr.js"></script>
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.js" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">gracl</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1> gracl</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<h1 id="-gracl-https-github-com-crosslead-gracl-graph-acl"><a href="https://github.com/CrossLead/gracl"><code>gracl</code></a> - Graph ACL</h1>
				<p><a href="https://travis-ci.org/CrossLead/gracl"><img src="https://travis-ci.org/CrossLead/gracl.svg?branch=master" alt="Build Status"></a>
				<a href="https://badge.fury.io/js/gracl"><img src="https://badge.fury.io/js/gracl.svg" alt="npm version"></a></p>
				<p>  <code>gracl</code> is an Access Control List library for managing permission models utilizing a hierarchy. In <code>gracl</code>, the permissions
				hierarchy is implemented using the prototype chain, and (Java/Type)script&#39;s great reflection capabilities.</p>
				<h2 id="usage-example">Usage Example</h2>
				<h3 id="example-problem-">Example problem...</h3>
				<p>Say you built an app for managing blogs within organizations. Within your database, you may different organizations (clients),
					which each have different blogs, which each have unique posts. Additionally, users within each organization belong to specific
				teams. Overall, we can define two hierarchies within the database, one for Subjects and one for resources.</p>
				<p>In this lingo, we are defining &quot;Subjects&quot; as objects which are allowed or denied access to &quot;Resources&quot;.</p>
				<pre><code>Subject Hierarchy           Resource Hierarchy

  +------------+             +------------+
  |<span class="hljs-string">Organization</span>|<span class="hljs-string">             </span>|<span class="hljs-string">Organization</span>|
  +------+-----+             +------+-----+
         |<span class="hljs-string">                          </span>|
         v                          v
      +--+-+                     +--+-+
      |<span class="hljs-string">Team</span>|<span class="hljs-string">                     </span>|<span class="hljs-string">Blog</span>|
      +--+-+                     +--+-+
         |<span class="hljs-string">                          </span>|
         v                          v
      +--+-+                     +--+-+
      |<span class="hljs-string">User</span>|<span class="hljs-string">                     </span>|<span class="hljs-string">Post</span>|
      +----+                     +----+
</code></pre><p>First looking at the subject Hierarchy, we see users are the lowest unit, above them are teams, and above teams
					are organizations. This means that when checking if a user has access to a given resource, we first check to see if
					they specifically have access to the resource. If not, we then check if any of their teams have access to the resource,
				and finally, if still no answer, we check if the organization the user has access to has access to the specific resource.</p>
				<p>This is all well and good if we define specific permissions for each blog post, but that doesn&#39;t seem practical does it!
				However, we don&#39;t want to just give the user access to all the posts in the blog (maybe there are executive eyes only posts).</p>
				<p>To reconcile this, we also need to introduce a resource hierarchy. This means, for each check on a given subject, we need to check
					if that subject has access to the resource at any point in the hierarchy. Moving back to the example, we would first check
					to see if the subject has access to a blog post, if no permission was specifically set for the blog post, we then need
					to check if the subject has access to the whole blog itself, and then finally if the subject has access to <strong>all</strong> blogs
				for a given organization.</p>
				<p>Note, in this example, organizations are <strong>both</strong> subjects and resources.</p>
				<h3 id="conflict-resolution">Conflict Resolution</h3>
				<p>Inevitably, conflicts between allows and denies of specific permissions will arise. For example (using the hierarchies above), consider a user being given acces to a specific post within a blog, but being denied the blog as a whole...</p>
				<pre><code class="lang-javascript"><span class="hljs-keyword">await</span> post.allow(user, <span class="hljs-string">'view'</span>);
<span class="hljs-keyword">await</span> blog.deny(user, <span class="hljs-string">'view'</span>);
</code></pre>
				<p>That is, the user is denied access to the blog itself, but allowed to look at a
					specific post. <code>gracl</code> reconciles this by making the lowest node in the hierarchy win.
					That means that if a user tries to access the post, it will be granted access, but
				if the user tries to access the blog, it will be denied.</p>
				<h3 id="example-code">Example code</h3>
				<p>To implement this example model using <code>gracl</code>, we would implement the requisite resource and subject classes.</p>
				<pre><code class="lang-javascript"><span class="hljs-comment">// =&gt;&gt; graclClasses.js</span>

<span class="hljs-comment">// for this example, assume we use mongodb, with separate collections for each entity</span>
<span class="hljs-comment">// assume we have models defined with getEntity(id: string) =&gt; Promise&lt;Document&gt; methods defined</span>
<span class="hljs-keyword">import</span> { OrganizationModel, TeamModel, UserModel, BlogModel, PostModel } <span class="hljs-keyword">from</span> <span class="hljs-string">'./models'</span>;

<span class="hljs-comment">// import the gracl base classes</span>
<span class="hljs-keyword">import</span> { Subject, Resource } <span class="hljs-keyword">from</span> <span class="hljs-string">'gracl'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrganizationResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Resource</span> </span>{
  <span class="hljs-keyword">static</span> id = <span class="hljs-string">'_id'</span>;
  <span class="hljs-keyword">static</span> repository = OrganizationModel;
}

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrganizationSubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Subject</span> </span>{
  <span class="hljs-keyword">static</span> id = <span class="hljs-string">'_id'</span>;
  <span class="hljs-keyword">static</span> repository = OrganizationModel;
}

<span class="hljs-comment">// Moving down the subject hierarchy chain, we simply extend the upper class</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeamSubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OrganizationSubject</span> </span>{
  <span class="hljs-keyword">static</span> repository = TeamModel;
  <span class="hljs-comment">// we need to define the property on Team documents which contains the parent id(s)</span>
  <span class="hljs-comment">// -- alternatively, a method of signature getParents() =&gt; Promise&lt;Resource|Subject&gt; can be</span>
  <span class="hljs-comment">//    directly defined.</span>
  <span class="hljs-keyword">static</span> parentId = <span class="hljs-string">'organizationId'</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TeamSubject</span> </span>{
  <span class="hljs-keyword">static</span> repository = UserModel;
  <span class="hljs-keyword">static</span> parentId = <span class="hljs-string">'teamIds'</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlogResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OrganizationResource</span> </span>{
  <span class="hljs-keyword">static</span> repository = BlogModel;
  <span class="hljs-keyword">static</span> parentId = <span class="hljs-string">'organizationId'</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BlogResource</span> </span>{
  <span class="hljs-keyword">static</span> repository = PostModel;
  <span class="hljs-keyword">static</span> parentId = <span class="hljs-string">'blogId'</span>;
}
</code></pre>
				<p>Once we&#39;ve implemented the classes, we can use them to add / deny permission and check for access.</p>
				<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> {
  UserSubject,
  PostResource
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./graclClasses'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">giveUserViewPermissionForPost</span>(<span class="hljs-params">user, post</span>) </span>{
  <span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> UserSubject(user),
        resource = <span class="hljs-keyword">new</span> PostResource(post);

  <span class="hljs-comment">/**
   *  add specific permission for this subject to view this resource.

      Note: the permission values here (second parameter of allow()) can be
      any arbitrary string. calling resource.allow(subject, permissionString)
      will create a permissions entry on the resource as follows:

      resource === {
        ...other_properties,
        permissions: [
          { subjectId: &lt;subjectId&gt;,
            access: {
              [permissionString]: true,
              ...(other permissions if exist)
            }
          }, ...(other subjects if exist)
        ]
      }
   */</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resource.allow(subject, <span class="hljs-string">'view'</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkUserViewPermissionForPost</span>(<span class="hljs-params">user, post</span>) </span>{
  <span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> UserSubject(user),
        resource = <span class="hljs-keyword">new</span> PostResource(post);

  <span class="hljs-comment">// recursively check entire hierarchy</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> subject.isAllowed(resource, <span class="hljs-string">'view'</span>);
}
</code></pre>
				<h3 id="alternative-setup-compact-version-">Alternative setup (compact version)</h3>
				<p>The subject + resource hierarchies can also be created automatically by providing a <strong>schema</strong>...</p>
				<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> { Graph } <span class="hljs-keyword">from</span> <span class="hljs-string">'gracl'</span>;

<span class="hljs-keyword">const</span> schema = {
  resources: [
    { name: <span class="hljs-string">'Post'</span>, parent: <span class="hljs-string">'Blog'</span>, parentId: <span class="hljs-string">'blogId'</span>, repository: classes.postModel },
    { name: <span class="hljs-string">'Blog'</span>, parent: <span class="hljs-string">'Organization'</span>, parentId: <span class="hljs-string">'organizationId'</span>, repository: classes.blogModel },
    { name: <span class="hljs-string">'Organization'</span>, repository: classes.orgModel }
  ],
  subjects: [
    { name: <span class="hljs-string">'User'</span>, parent: <span class="hljs-string">'Team'</span>, parentId: <span class="hljs-string">'teamIds'</span>, repository: classes.userModel },
    { name: <span class="hljs-string">'Team'</span>, parent: <span class="hljs-string">'Organization'</span>, parentId: <span class="hljs-string">'organizationId'</span>, repository: classes.teamModel },
    { name: <span class="hljs-string">'Organization'</span>, repository: classes.orgModel }
  ]
};

<span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> Graph(schema);

<span class="hljs-comment">// Now, the classes can be extracted from the graph to define the functions above...</span>
<span class="hljs-keyword">const</span> UserSubject = graph.getSubject(<span class="hljs-string">'User'</span>),
      PostResource = graph.getResource(<span class="hljs-string">'Post'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkUserViewPermissionForPost</span>(<span class="hljs-params">user, post</span>) </span>{
  <span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> UserSubject(user),
        resource = <span class="hljs-keyword">new</span> PostResource(post);

  <span class="hljs-comment">// recursively check entire hierarchy</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> subject.isAllowed(resource, <span class="hljs-string">'view'</span>);
}
</code></pre>
				<h2 id="dev-setup">Dev setup</h2>
				<ol>
					<li>run <code>npm install</code></li>
					<li>run <code>npm run build</code></li>
				</ol>
				<h2 id="development-tasks-npm-run-task-">Development tasks (<code>npm run &lt;task&gt;</code>)</h2>
				<ul>
					<li><code>build</code> : install type definintions and compile the project</li>
					<li><code>pretest</code> : recompile for testing</li>
					<li><code>test</code> : run mocha tests</li>
					<li><code>tscompile</code> : compile typescript -&gt; es6</li>
					<li><code>typings</code> : install type definitions</li>
					<li><code>browserify</code> : compile es6 -&gt; es5</li>
					<li><code>minify</code> : minify es5 output</li>
					<li><code>docs</code> : build documentation locally</li>
					<li><code>gh-pages</code> : build documentation and publish to github pages</li>
					<li><code>lint</code> : run tslint on project</li>
				</ul>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
					<li class=" tsd-kind-class">
						<a href="classes/graph.html" class="tsd-kind-icon">Graph</a>
					</li>
					<li class=" tsd-kind-class">
						<a href="classes/memoryrepository.html" class="tsd-kind-icon">Memory<wbr>Repository</a>
					</li>
					<li class=" tsd-kind-class">
						<a href="classes/node.html" class="tsd-kind-icon">Node</a>
					</li>
					<li class=" tsd-kind-class">
						<a href="classes/resource.html" class="tsd-kind-icon">Resource</a>
					</li>
					<li class=" tsd-kind-class">
						<a href="classes/subject.html" class="tsd-kind-icon">Subject</a>
					</li>
					<li class=" tsd-kind-interface">
						<a href="interfaces/repository.html" class="tsd-kind-icon">Repository</a>
					</li>
					<li class=" tsd-kind-interface">
						<a href="interfaces/schemanode.html" class="tsd-kind-icon">Schema<wbr>Node</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#accessresult" class="tsd-kind-icon">Access<wbr>Result</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#document" class="tsd-kind-icon">Document</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#documentdata" class="tsd-kind-icon">Document<wbr>Data</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#hash" class="tsd-kind-icon">Hash</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#hierarchynode" class="tsd-kind-icon">Hierarchy<wbr>Node</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#permopts" class="tsd-kind-icon">Perm<wbr>Opts</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#permission" class="tsd-kind-icon">Permission</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#permissionshierarchy" class="tsd-kind-icon">Permissions<wbr>Hierarchy</a>
					</li>
					<li class=" tsd-kind-type-alias">
						<a href="globals.html#schema" class="tsd-kind-icon">Schema</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#basecompare" class="tsd-kind-icon">base<wbr>Compare</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#binaryindexof" class="tsd-kind-icon">binary<wbr>Index<wbr>Of</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#getclassof" class="tsd-kind-icon">get<wbr>Class<wbr>Of</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#noop" class="tsd-kind-icon">noop</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#permissioncompare" class="tsd-kind-icon">permission<wbr>Compare</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#permissionindexof" class="tsd-kind-icon">permission<wbr>Index<wbr>Of</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#topologicalsort" class="tsd-kind-icon">topological<wbr>Sort</a>
					</li>
					<li class=" tsd-kind-function">
						<a href="globals.html#yes" class="tsd-kind-icon">yes</a>
					</li>
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-module"><span class="tsd-kind-icon">Module</span></li>
				<li class="tsd-kind-object-literal"><span class="tsd-kind-icon">Object literal</span></li>
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-index-signature"><span class="tsd-kind-icon">Index signature</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-enum"><span class="tsd-kind-icon">Enumeration</span></li>
				<li class="tsd-kind-enum-member"><span class="tsd-kind-icon">Enumeration member</span></li>
				<li class="tsd-kind-property tsd-parent-kind-enum"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-enum"><span class="tsd-kind-icon">Method</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-interface"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-interface"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
				<li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class"><span class="tsd-kind-icon">Accessor</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-class"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-constructor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static property</span></li>
				<li class="tsd-kind-call-signature tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="http://typedoc.io" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="assets/js/search.js"><' + '/script>');</script>
</body>
</html>